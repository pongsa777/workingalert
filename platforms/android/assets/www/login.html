<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/roboto.min.css" rel="stylesheet">
    <link href="css/material.min.css" rel="stylesheet">
    <link href="css/ripples.min.css" rel="stylesheet">
    <link href="css/seven.css" rel="stylesheet">
</head>

<body>

    <!-- Your site -->

    <div class="container">
        <div id="logoicn">
            <img src="pic/app_icon.png" style="width:80%;">
        </div>
        <div class="jumbotron">
            <input type="email" id="email" class="form-control floating-label" placeholder="email">
            <input type="password" id="pass" class="form-control floating-label" placeholder="password" id="pass">
            <a href="#" class="btn btn-primary" id="loginbtn" style="width:100%">Login</a>
            <a href="#" class="btn btn-info" style="width:100%" id="fbloginbtn">facebook login</a>
            <a href="register.html"><h5>register</h5></a>
            <a href="forget.html"><h5>forget password</h5></a>
        </div>

    </div>



    <!-- Your site ends -->
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="cordova_plugins.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/openfb.js"></script>
    <script src="js/ripples.min.js"></script>
    <script src="js/material.min.js"></script>
    <script>
        $(document).ready(function() {
            // This command is used to initialize some elements and make them work properly
            openFB.init({
                appId: '102368486782958',
                tokenStore: window.localStorage
            });

            $("#fbloginbtn").on("click", function(e) {
                alert('fb login fn');
                    openFB.login(
                    function(response) {
                        if (response.status === 'connected') {
                            alert('Facebook login succeeded, got access token: ' + response.authResponse.accessToken);
                            localStorage.setItem("fbtoken",response.authResponse.accessToken);
                            getInfo();
                        } else {
                            alert('Facebook login failed: ' + response.error);
                        }
                    }, {
                        scope: 'email'
                    });
                
                
                    alert('getinfo');
                    openFB.api({
                        path: '/me',
                        success: function(response) {
                            alert('success');
                            alert(JSON.stringify(response));
                            var fbid = response.id;
                            var url = "http://workingalert.tk/api/authenfb.php?fbid=" + fbid;
                            alert(url);
                            $.get(url, function(data, status) {
                                alert(status);
                                alert(JSON.stringify(data));
                                if (data.status == 'success') {
                                    localStorage.setItem("sessionid", data.sessionid);
                                    document.location.href = "mainmenu.html";
                                } else {
                                    alert('go to register new acc');
                                    localStorage.setItem("fbid", fbid);
                                    var fullname = response.name;
                                    var name = fullname.substr(0, fullname.indexOf(' '));
                                    var surname = fullname.substr(fullname.indexOf(' ') + 1);
                                    localStorage.setItem("name", name);
                                    localStorage.setItem("surname", surname);
                                    document.location.href = "registerfb.html";
                                }
                            });
                        },
                        error: function(data) {
                            alert('failed');
                            alert(JSON.stringify(data));
                        }
                    });
                

            });

            $("#loginbtn").on("click", function(e) {
                var email = $("#email").val();
                var password = $("#pass").val();
                var url = "http://workingalert.tk/api/authen.php?email=" + email + "&pass=" + password;
                $.get(url, function(data, status) {
                    alert(JSON.stringify(data));
                    if (data.status == 'success') {
                        localStorage.setItem("sessionid", data.sessionid);
                        document.location.href = "mainmenu.html";
                    }
                });
            });
        });

    </script>

</body>

</html>
